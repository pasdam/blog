<!doctype html><html lang=en><head><meta charset=utf-8><title>The Optional anti-patterns in Java &ndash; /dev/null
</title><link href="https://fonts.googleapis.com/css?family=Work+Sans:600|Quattrocento+Sans:400,400i,700" rel=stylesheet type=text/css><link rel=icon href=https://pasdam.github.io/blog/favicon.svg><link rel=stylesheet href=https://pasdam.github.io/blog/global.min.css><meta name=description content="Article to show few cases when using Optional in Java is an anti-pattern"><meta name=viewport content="width=device-width,initial-scale=1"><link rel="preconnect dns-prefetch" href=https://www.google-analytics.com></head><body><script>function gaOptout(){document.cookie=disableStr+"=true; expires=Thu, 31 Dec 2099 23:59:59 UTC;path=/",window[disableStr]=!0}var gaProperty="UA-20503043-3",disableStr="ga-disable-"+gaProperty;document.cookie.indexOf(disableStr+"=true")>-1&&(window[disableStr]=!0),parseInt(navigator.doNotTrack)===1||parseInt(window.doNotTrack)===1||parseInt(navigator.msDoNotTrack)===1||navigator.doNotTrack==="yes"||function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),typeof ga=="function"&&(ga("create","UA-20503043-3","auto",{}),ga("set","anonymizeIp",!0))</script><header id=page-header class=bg-green><a href=https://pasdam.github.io/blog/><h1>/dev/null</h1></a></header><div id=main><div class=post-body><h1 class=text-green>The Optional anti-patterns in Java</h1><p class=date-read-time>September 27, 2019 &mdash; 6 Min Read</p><hr><div class=tags><div class=tag><a href=/blog/tags/antipattern/ class=test>Antipattern</a></div><div class=tag><a href=/blog/tags/engineering/ class=test>Engineering</a></div><div class=tag><a href=/blog/tags/java/ class=test>Java</a></div><div class=tag><a href=/blog/tags/pattern/ class=test>Pattern</a></div></div><hr><nav id=TableOfContents><ul><li><a href=#things-to-keep-in-mind-about-optional>Things to keep in mind about Optional</a><ul><li><a href=#garbage-collection>Garbage collection</a></li><li><a href=#eager-operations>Eager operations</a></li></ul></li><li><a href=#use-cases>Use cases</a><ul><li><a href=#optional-as-method-return-type>Optional as method return type</a></li><li><a href=#optional-as-class-field>Optional as class field</a></li><li><a href=#optional-as-method-argument>Optional as method argument</a></li><li><a href=#other-anti-patterns>Other anti patterns</a></li></ul></li><li><a href=#summary>Summary</a></li></ul></nav><hr><div class=content><p>Traditionally, Java programs have returned null as a way to represent that a value isn’t present. The version 8 of the SDK includes a new class which was made specifically to manage missing values.</p><p>I won&rsquo;t describe the details of the <a href=https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html>Optional</a> class, but very briefly it&rsquo;s a container object which may or may not contain a non-null value. Therefore, it is possible to manipulate null values as if they were normal instances without necessarily having to perform a null check at every step.</p><p>In this article, I&rsquo;m going to talk about experiences I gathered while working with Java and describe some anti-patterns I&rsquo;ve seen about such class.</p><p>A <a href=http://stackoverflow.com/a/26328555/547365>Stack Overflow answer by Brian Goetz</a>, Java’s language architect, sheds light on Oracle’s intention with the Optional type:</p><blockquote><p>Of course, people will do what they want. But we did have a clear intention when adding this feature, and it was not to be a general purpose Maybe or Some type, as much as many people would have liked us to do so. Our intention was to provide a limited mechanism for library method return types where there needed to be a clear way to represent &ldquo;no result&rdquo;, and using null for such was overwhelmingly likely to cause errors.</p></blockquote><p>I generally agree with his statement: <code>Optional</code> should be used with care and not as a panacea for all problems. IMHO in most cases <code>Optional</code> is just a new name for null.</p><h2 id=things-to-keep-in-mind-about-optional>Things to keep in mind about Optional</h2><p>According to the <a href=https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/util/Optional.html>documentation</a>:</p><blockquote><p>Use of identity-sensitive operations (including reference equality (==), identity hash code, or synchronization) on instances of Optional may have unpredictable results and should be avoided.</p><p>Optional is primarily intended for use as a method return type where there is a clear need to represent &ldquo;no result,&rdquo; and where using null is likely to cause errors.</p></blockquote><h3 id=garbage-collection>Garbage collection</h3><p>Also another things to keep in mind is that it creates an extra object for the garbage collector. For server systems running at scale, you definitely don&rsquo;t want lots of little object boxes within your beans.</p><p>Interestingly, if <code>Optional</code> becomes a value type in a future Java version, then the memory/gc issue goes away.</p><h3 id=eager-operations>Eager operations</h3><p>When you use <code>Optional::orElse</code> method you should remember that it does not behave the same way as <code>if-else</code> block. For instance, with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Optional.<span style=color:#a6e22e>ofNullable</span>(content).<span style=color:#a6e22e>orElse</span>(logToFile())
</span></span></code></pre></div><p>the <code>logToFile</code> method is executed all the time, whereas with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>if</span> (content <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>  logToFile();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>it runs only if the condition is met (lazily).</p><p>The instruction can be harmless as creating a string, but it can also be a hidden performance killer.</p><h2 id=use-cases>Use cases</h2><h3 id=optional-as-method-return-type>Optional as method return type</h3><p>If we have a method that returns something, we must inspect the documentation to find out whether or not it may be null.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> V <span style=color:#a6e22e>get</span>(Object key);
</span></span></code></pre></div><p>To overcome this problematic situation, developers invented many methods like annotations (Nullable, NotNull), naming-conventions (e.g. prefixing a method with find instead of get) or just using code-comments to hint that a method may intentionally return null and the invoker should care about this case.</p><p>By returning <code>Optional&lt;V></code> instead, there is a clear indication that the method may not return any value at all:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> Optional<span style=color:#f92672>&lt;</span>V<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>get</span>(Object key);
</span></span></code></pre></div><p>My personal take on it is in general to prefer null with an annotation, as no additional object is created.</p><p>When dealing with collections an anti-pattern is to return an <code>Optional</code> of a collection:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> Optional<span style=color:#f92672>&lt;</span>List<span style=color:#f92672>&lt;</span>V<span style=color:#f92672>&gt;&gt;</span> <span style=color:#a6e22e>get</span>(Object key) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>list</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>list</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> Optional.<span style=color:#a6e22e>empty</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This can be replaced with a simpler empty collection:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>V<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>get</span>(Object key) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>list</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>list</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> Collections.<span style=color:#a6e22e>emptyList</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=streams>Streams</h4><p>The actual use case for <code>Optionals</code> is functional programming. If you use this, you will filter, map or reduce data and you will often come to the point where there might be the possibility that no data exists. It’s a good idea to use Optionals here, as you often write this code in a fluent style. A null pointer is really ugly to handle here.</p><h3 id=optional-as-class-field>Optional as class field</h3><p>This is an anti-pattern, and the main reason is that the <code>Optional</code> class is not serializable.</p><p>A better solution would be to make store the field with the actual type and make the getter method return an <code>Optional</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Car</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>Wheel<span style=color:#f92672>&gt;</span> wheels;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> Engine engine;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> Optional<span style=color:#f92672>&lt;</span>Engine<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getEngine</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> Optional.<span style=color:#a6e22e>ofNullable</span>(engine);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Keep in mind that with this approach you&rsquo;re creating a new object every time the getter is called.</p><h3 id=optional-as-method-argument>Optional as method argument</h3><p>Having an optional-typed parameter in a function is a code smell: this was an anti-pattern before (having a parameter that can intentionally be null, and is handled differently if it is) and stays an anti-pattern now (having an optional-typed parameter), you either way have some decision to make if you do something with the parameter if it is there, or you do something else if it is not. A method implemented this way shows a design-flaw in every case. I can have one version with and one version without the parameter, and decide in the point of invocation what to do, instead of deciding it hidden in some complex function.</p><p>This applies to everything: constructors, setters, or any other method.</p><h3 id=other-anti-patterns>Other anti patterns</h3><p>A variable whose type is <code>Optional</code> should never itself be null; it should always point to a valid instance.</p><p>Using <code>Optional</code> in collections can be a design smell: there is no need to have <code>List</code> of <code>Optional</code>s that might or might not have a value; we can have a smaller or even empty <code>List</code> of concrete objects instead.</p><p>Don&rsquo;t use optional just to check if a value is null:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Optional.<span style=color:#a6e22e>ofNullable</span>(value)
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>map</span>(<span style=color:#66d9ef>this</span>::doSthWithTheField)
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>orElse</span>(<span style=color:#66d9ef>this</span>::doSthElse)
</span></span></code></pre></div><p>in the previous code <code>value</code> can be null, and is wrapped with an <code>Optional</code> just to decide in a functional way what to do with it, the traditional way would be a better approach:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>if</span> (value <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>  doSthWithTheField(value);
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>  doSthElse(value);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=summary>Summary</h2><p>Use Optional with caution:</p><ul><li>do not forget about the eagerness of some operations;</li><li>do not use Optional or its variants if you’re trying to avoid heap allocations, and minimize object creations;</li><li><code>Optional</code>s are ok as method return types and can potentially cause problems if used in fields, parameters and collections;</li><li>keep your <code>Optional</code> simple, do not force it to do something it was not designed for;</li><li>avoid having <code>Optional</code>s in collections, just fill them with the present values directly; also do not use them to return collections or arrays, favor returning an empty collection/array;</li><li>Avoid <code>Optional::isPresent</code> followed by <code>Optional::get</code>, use <code>ifPresentOrElse</code> instead</li></ul></div></div></div><button class=hidden id=to-top-button onclick=goToTop() title="Go To Top">
<svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="chevron-circle-up" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M8 256C8 119 119 8 256 8s248 111 248 248-111 248-248 248S8 393 8 256zm231-113.9L103.5 277.6c-9.4 9.4-9.4 24.6.0 33.9l17 17c9.4 9.4 24.6 9.4 33.9.0L256 226.9l101.6 101.6c9.4 9.4 24.6 9.4 33.9.0l17-17c9.4-9.4 9.4-24.6.0-33.9L273 142.1c-9.4-9.4-24.6-9.4-34 0z"/></svg>
</button>
<script async>const offset=100;var toTopButton=document.getElementById("to-top-button");window.onscroll=function(){document.body.scrollTop>offset||document.documentElement.scrollTop>offset?toTopButton.classList.remove("hidden"):toTopButton.classList.add("hidden")};function goToTop(){window.scrollTo({top:0,behavior:"smooth"})}</script></body></html>