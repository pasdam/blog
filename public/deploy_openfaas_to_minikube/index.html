<!doctype html><html lang=en><head><meta charset=utf-8><title>Deploy OpenFaas to minikube &ndash; /dev/null
</title><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Work+Sans:600|Quattrocento+Sans:400,400i,700" type=text/css><link rel=stylesheet href=https://pasdam.github.io/blog/global.min.css><link rel=icon href=https://pasdam.github.io/blog/favicon.svg><meta name=description content="Tutorial on how to deploy OpenFaaS to kubernetes, using minikube"><meta name=viewport content="width=device-width,initial-scale=1"><script async src="https://www.googletagmanager.com/gtag/js?id=G-H52BY7123V"></script><script async>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-H52BY7123V",{cookie_flags:"SameSite=None;Secure"})</script></head><body><header id=page-header class=bg-green><a href=https://pasdam.github.io/blog/><h1>/dev/null</h1></a></header><div id=main><div class=post-body><h1 class=text-green>Deploy OpenFaas to minikube</h1><p class=date-read-time>May 21, 2020 &mdash; 2 Min Read</p><hr><div class=tags><div class=tag><a href=/blog/tags/docker/ class=test>Docker</a></div><div class=tag><a href=/blog/tags/kubernetes/ class=test>Kubernetes</a></div><div class=tag><a href=/blog/tags/minikube/ class=test>Minikube</a></div><div class=tag><a href=/blog/tags/openfaas/ class=test>OpenFAAS</a></div></div><hr><nav id=TableOfContents><ul><li><a href=#requirements>Requirements</a></li><li><a href=#start-minikube>Start minikube</a></li><li><a href=#deploy-openfaas>Deploy OpenFaas</a></li><li><a href=#deploy-custom-function>Deploy custom function</a></li></ul></nav><hr><div class=content><p><a href=https://www.openfaas.com/>OpenFaas</a> is an open source
<a href=https://en.wikipedia.org/wiki/Function_as_a_service>FaaS</a> platform that
allows to deploy event-driven functions and microservices to Kubernetes quickly.</p><p>In this tutorial we will see how to deploy it. In particular we will use
<a href=https://github.com/kubernetes/minikube>minikube</a>, which implements a simple
local k8s cluster.</p><p>Source: <a href=https://docs.openfaas.com/deployment/kubernetes/#c-deploy-using-kubectl-and-plain-yaml-for-development-only>OpenFaas Doc</a></p><h2 id=requirements>Requirements</h2><p>This are the tools used, in parenthesis the version used for the tutorial:</p><ul><li><a href=https://www.docker.com>docker</a> (19.03.8);</li><li><a href=https://helm.sh>helm</a> (3.2.1);</li><li><a href=https://github.com/kubernetes/minikube>minikube</a> (1.10.1);</li><li><a href=https://github.com/openfaas/faas-cli#get-started-install-the-cli>openfaas cli</a>
(0.12.4).</li></ul><p>Please refer to the respective documentation on how to install them.</p><h2 id=start-minikube>Start minikube</h2><p>We will use minikube with the docker driver so that the k8s node will be
running in a container:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>minikube start --driver<span style=color:#f92672>=</span>docker
</span></span></code></pre></div><h2 id=deploy-openfaas>Deploy OpenFaas</h2><p>First thing to do is to create the required namespaces:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl apply -f https://raw.githubusercontent.com/openfaas/faas-netes/master/namespaces.yml
</span></span><span style=display:flex><span>namespace/openfaas created
</span></span><span style=display:flex><span>namespace/openfaas-fn created
</span></span></code></pre></div><p>Then we should create credentials for the <a href=https://docs.openfaas.com/architecture/gateway/>gateway</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>PASSWORD<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>head -c <span style=color:#ae81ff>12</span> /dev/urandom | shasum | cut -d<span style=color:#e6db74>&#39; &#39;</span> -f1<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>kubectl -n openfaas create secret generic basic-auth <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --from-literal<span style=color:#f92672>=</span>basic-auth-user<span style=color:#f92672>=</span>admin <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --from-literal<span style=color:#f92672>=</span>basic-auth-password<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$PASSWORD<span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><p>At this point we need to add the repository to be able to download the helm
template:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm repo add openfaas https://openfaas.github.io/faas-netes/
</span></span><span style=display:flex><span>helm repo update
</span></span></code></pre></div><p>Now we can generate the deployment files using Helm and apply it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm template <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  openfaas openfaas/openfaas <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --namespace openfaas <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --set basic_auth<span style=color:#f92672>=</span>true <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --set functionNamespace<span style=color:#f92672>=</span>openfaas-fn <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --set faasnetes.imagePullPolicy<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;IfNotPresent&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --set ingress.enabled<span style=color:#f92672>=</span>true &gt; openfaas.yaml
</span></span><span style=display:flex><span>kubectl apply -f openfaas.yaml
</span></span></code></pre></div><p>OpenFaas should be deployed now:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl get pods -n openfaas
</span></span><span style=display:flex><span>NAME                                 READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>alertmanager-9668b5785-2ftwn         1/1     Running   <span style=color:#ae81ff>0</span>          10m
</span></span><span style=display:flex><span>basic-auth-plugin-56c84b75b6-khhkx   1/1     Running   <span style=color:#ae81ff>0</span>          10m
</span></span><span style=display:flex><span>faas-idler-6c9b9cb54f-fnr89          1/1     Running   <span style=color:#ae81ff>0</span>          10m
</span></span><span style=display:flex><span>gateway-6bff97c6cd-twfpv             2/2     Running   <span style=color:#ae81ff>0</span>          10m
</span></span><span style=display:flex><span>nats-58d4d5db8d-k22kp                1/1     Running   <span style=color:#ae81ff>0</span>          10m
</span></span><span style=display:flex><span>prometheus-8b754b655-lmfft           1/1     Running   <span style=color:#ae81ff>0</span>          10m
</span></span><span style=display:flex><span>queue-worker-744c85f647-qkb2t        1/1     Running   <span style=color:#ae81ff>0</span>          10m
</span></span></code></pre></div><p>Next step is to port-forward the gateway to the local machine:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl port-forward svc/gateway -n openfaas 31112:8080 &amp;
</span></span></code></pre></div><p>so that we can login:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>export OPENFAAS_URL<span style=color:#f92672>=</span>http://127.0.0.1:31112
</span></span><span style=display:flex><span>echo -n $PASSWORD | faas-cli login --password-stdin
</span></span></code></pre></div><p>and eventually open the web ui at <a href=http://localhost:31112>localhost:31112</a>.</p><h2 id=deploy-custom-function>Deploy custom function</h2><p>In order to deploy local function to the cluster, it&rsquo;s necessary to point your
shell to use minikube&rsquo;s docker deamon:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>eval <span style=color:#66d9ef>$(</span>minikube docker-env<span style=color:#66d9ef>)</span>
</span></span></code></pre></div><p>This step is necessary as during the deploy OpenFaas needs to pull the function&rsquo;s
image, but the host&rsquo;s daemon is not available inside the cluster, hence it won&rsquo;t
be possible to pull the image from it.</p><p>So now we can build the function (refer to the
<a href=https://docs.openfaas.com/cli/templates/>official documentation</a> to see how
to write one):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>faas build
</span></span></code></pre></div><p>This last command will build the image inside the minikube container itself, so
the image will be available to OpenFaas when we will perform the deploy with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>faas deploy
</span></span></code></pre></div></div></div></div><button class=hidden id=to-top-button onclick=goToTop() title="Go To Top">
<svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="chevron-circle-up" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M8 256C8 119 119 8 256 8s248 111 248 248-111 248-248 248S8 393 8 256zm231-113.9L103.5 277.6c-9.4 9.4-9.4 24.6.0 33.9l17 17c9.4 9.4 24.6 9.4 33.9.0L256 226.9l101.6 101.6c9.4 9.4 24.6 9.4 33.9.0l17-17c9.4-9.4 9.4-24.6.0-33.9L273 142.1c-9.4-9.4-24.6-9.4-34 0z"/></svg>
</button>
<script async>const offset=100;var toTopButton=document.getElementById("to-top-button");window.onscroll=function(){document.body.scrollTop>offset||document.documentElement.scrollTop>offset?toTopButton.classList.remove("hidden"):toTopButton.classList.add("hidden")};function goToTop(){window.scrollTo({top:0,behavior:"smooth"})}</script></body></html>